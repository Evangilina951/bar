<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Бар</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100">
  <div id="app" class="container mx-auto p-4">
    <!-- Навигация -->
    <nav id="nav" class="bg-blue-600 text-white p-4 mb-4 rounded">
      <button id="nav-login" class="mr-2" onclick="showPage('login')">Вход</button>
      <button id="nav-menu" class="mr-2 hidden" onclick="showPage('menu')">Меню</button>
      <button id="nav-promocodes" class="mr-2 hidden" onclick="showPage('promocodes')">Промокоды</button>
      <button id="nav-dishes" class="mr-2 hidden" onclick="showPage('dishes')">Блюда</button>
      <button id="nav-inventory" class="mr-2 hidden" onclick="showPage('inventory')">Инвентаризация</button>
      <button id="nav-order-ingredients" class="mr-2 hidden" onclick="showPage('order-ingredients')">Заказ ингредиентов</button>
      <button id="nav-personal-report" class="mr-2 hidden" onclick="showPage('personal-report')">Личная отчетность</button>
      <button id="nav-general-report" class="mr-2 hidden" onclick="showPage('general-report')">Общая отчетность</button>
      <button id="nav-employees" class="mr-2 hidden" onclick="showPage('employees')">Сотрудники</button>
      <button id="nav-delivery" class="mr-2 hidden" onclick="showPage('delivery')">Доставка</button>
      <button id="nav-delivery-orders" class="mr-2 hidden" onclick="showPage('delivery-orders')">Заказы доставки</button>
      <button id="logout" class="hidden" onclick="logout()">Выход</button>
    </nav>

    <!-- Страницы -->
    <div id="login" class="page">
      <h1 class="text-2xl mb-4">Авторизация</h1>
      <input id="email" type="email" placeholder="Email" class="border p-2 mb-2 w-full">
      <input id="password" type="password" placeholder="Пароль" class="border p-2 mb-2 w-full">
      <button onclick="login()" class="bg-blue-600 text-white p-2 rounded">Войти</button>
    </div>

    <div id="menu" class="page hidden">
      <h1 class="text-2xl mb-4">Меню</h1>
      <div id="categories" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
      <div id="order" class="mt-4">
        <h2 class="text-xl">Ваш заказ</h2>
        <ul id="order-items"></ul>
        <input id="order-comment" type="text" placeholder="Комментарий к заказу" class="border p-2 mt-2 w-full">
        <button onclick="placeOrder()" class="bg-green-600 text-white p-2 rounded mt-2">Оформить заказ</button>
      </div>
    </div>

    <div id="promocodes" class="page hidden">
      <h1 class="text-2xl mb-4">Промокоды и наборы</h1>
      <input id="promo-code" type="text" placeholder="Код" class="border p-2 mb-2">
      <input id="promo-discount" type="number" placeholder="Скидка (%)" class="border p-2 mb-2">
      <button onclick="addPromocode()" class="bg-blue-600 text-white p-2 rounded">Добавить</button>
      <ul id="promocodes-list" class="mt-4"></ul>
    </div>

    <div id="dishes" class="page hidden">
      <h1 class="text-2xl mb-4">Блюда и категории</h1>
      <input id="dish-name" type="text" placeholder="Название блюда" class="border p-2 mb-2">
      <input id="dish-price" type="number" placeholder="Цена" class="border p-2 mb-2">
      <select id="dish-category" class="border p-2 mb-2"></select>
      <button onclick="addDish()" class="bg-blue-600 text-white p-2 rounded">Добавить блюдо</button>
      <input id="category-name" type="text" placeholder="Новая категория" class="border p-2 mb-2 mt-4">
      <button onclick="addCategory()" class="bg-blue-600 text-white p-2 rounded">Добавить категорию</button>
      <ul id="dishes-list" class="mt-4"></ul>
    </div>

    <div id="inventory" class="page hidden">
      <h1 class="text-2xl mb-4">Инвентаризация</h1>
      <input id="ingredient-name" type="text" placeholder="Название ингредиента" class="border p-2 mb-2">
      <input id="ingredient-quantity" type="number" placeholder="Количество" class="border p-2 mb-2">
      <input id="ingredient-price" type="number" placeholder="Цена за единицу" class="border p-2 mb-2">
      <button onclick="addIngredient()" class="bg-blue-600 text-white p-2 rounded">Добавить ингредиент</button>
      <ul id="inventory-list" class="mt-4"></ul>
    </div>

    <div id="order-ingredients" class="page hidden">
      <h1 class="text-2xl mb-4">Заказ ингредиентов</h1>
      <ul id="order-ingredients-list" class="mt-4"></ul>
      <button onclick="placeIngredientOrder()" class="bg-green-600 text-white p-2 rounded mt-2">Заказать</button>
    </div>

    <div id="personal-report" class="page hidden">
      <h1 class="text-2xl mb-4">Личная отчетность</h1>
      <ul id="personal-report-list" class="mt-4"></ul>
    </div>

    <div id="general-report" class="page hidden">
      <h1 class="text-2xl mb-4">Общая отчетность</h1>
      <input id="report-start" type="date" class="border p-2 mb-2">
      <input id="report-end" type="date" class="border p-2 mb-2">
      <button onclick="generateGeneralReport()" class="bg-blue-600 text-white p-2 rounded">Сформировать</button>
      <ul id="general-report-list" class="mt-4"></ul>
    </div>

    <div id="employees" class="page hidden">
      <h1 class="text-2xl mb-4">Сотрудники</h1>
      <input id="employee-name" type="text" placeholder="Имя" class="border p-2 mb-2">
      <input id="employee-phone" type="text" placeholder="Телефон" class="border p-2 mb-2">
      <button onclick="addEmployee()" class="bg-blue-600 text-white p-2 rounded">Добавить сотрудника</button>
      <ul id="employees-list" class="mt-4"></ul>
    </div>

    <div id="delivery" class="page hidden">
      <h1 class="text-2xl mb-4">Заказ доставки</h1>
      <div id="delivery-menu" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
      <div id="delivery-order" class="mt-4">
        <h2 class="text-xl">Ваш заказ</h2>
        <ul id="delivery-order-items"></ul>
        <input id="delivery-address" type="text" placeholder="Адрес доставки" class="border p-2 mt-2 w-full">
        <input id="delivery-comment" type="text" placeholder="Комментарий" class="border p-2 mt-2 w-full">
        <button onclick="placeDeliveryOrder()" class="bg-green-600 text-white p-2 rounded mt-2">Оформить доставку</button>
      </div>
    </div>

    <div id="delivery-orders" class="page hidden">
      <h1 class="text-2xl mb-4">Заказы доставки</h1>
      <ul id="delivery-orders-list" class="mt-4"></ul>
    </div>
  </div>

  <script>
    // Инициализация Firebase
    const firebaseConfig = {
      // Вставьте ваш конфиг Firebase здесь
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Роутинг страниц
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
      document.getElementById(pageId).classList.remove('hidden');
    }

    // Авторизация
    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          document.getElementById('nav-login').classList.add('hidden');
          document.querySelectorAll('#nav button:not(#logout)').forEach(btn => btn.classList.remove('hidden'));
          document.getElementById('logout').classList.remove('hidden');
          showPage('menu');
        })
        .catch(error => alert('Ошибка входа: ' + error.message));
    }

    function logout() {
      auth.signOut().then(() => {
        document.getElementById('nav-login').classList.remove('hidden');
        document.querySelectorAll('#nav button:not(#nav-login)').forEach(btn => btn.classList.add('hidden'));
        showPage('login');
      });
    }

    // Загрузка категорий и блюд
    async function loadMenu() {
      const categories = await db.collection('categories').get();
      const dishes = await db.collection('dishes').get();
      const categoriesDiv = document.getElementById('categories');
      categoriesDiv.innerHTML = '';
      categories.forEach(cat => {
        const catDiv = document.createElement('div');
        catDiv.innerHTML = `<h2 class="text-xl">${cat.data().name}</h2>`;
        dishes.forEach(dish => {
          if (dish.data().category === cat.id) {
            catDiv.innerHTML += `
              <div class="border p-2">
                <p>${dish.data().name} - ${dish.data().price} руб.</p>
                <button onclick="addToOrder('${dish.id}', '${dish.data().name}', ${dish.data().price})" class="bg-blue-600 text-white p-1 rounded">Добавить</button>
              </div>`;
          }
        });
        categoriesDiv.appendChild(catDiv);
      });
    }

    // Добавление в заказ
    let orderItems = [];
    function addToOrder(dishId, name, price) {
      orderItems.push({ dishId, name, price });
      renderOrder();
    }

    function renderOrder() {
      const orderList = document.getElementById('order-items');
      orderList.innerHTML = '';
      orderItems.forEach(item => {
        orderList.innerHTML += `<li>${item.name} - ${item.price} руб.</li>`;
      });
    }

    // Оформление заказа
    async function placeOrder() {
      const comment = document.getElementById('order-comment').value;
      await db.collection('orders').add({
        items: orderItems,
        comment,
        user: auth.currentUser.uid,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      // Списание ингредиентов
      for (const item of orderItems) {
        const dish = await db.collection('dishes').doc(item.dishId).get();
        const ingredients = dish.data().ingredients || [];
        for (const ing of ingredients) {
          const ingredientRef = db.collection('ingredients').doc(ing.id);
          const ingredient = await ingredientRef.get();
          await ingredientRef.update({
            quantity: ingredient.data().quantity - ing.quantity
          });
        }
      }
      orderItems = [];
      renderOrder();
      alert('Заказ оформлен!');
    }

    // Управление промокодами
    async function addPromocode() {
      const code = document.getElementById('promo-code').value;
      const discount = parseInt(document.getElementById('promo-discount').value);
      await db.collection('promocodes').add({ code, discount });
      loadPromocodes();
    }

    async function loadPromocodes() {
      const promocodes = await db.collection('promocodes').get();
      const list = document.getElementById('promocodes-list');
      list.innerHTML = '';
      promocodes.forEach(promo => {
        list.innerHTML += `<li>${promo.data().code} - ${promo.data().discount}%</li>`;
      });
    }

    // Управление блюдами и категориями
    async function addDish() {
      const name = document.getElementById('dish-name').value;
      const price = parseInt(document.getElementById('dish-price').value);
      const category = document.getElementById('dish-category').value;
      await db.collection('dishes').add({ name, price, category });
      loadDishes();
    }

    async function addCategory() {
      const name = document.getElementById('category-name').value;
      await db.collection('categories').add({ name });
      loadCategories();
    }

    async function loadDishes() {
      const dishes = await db.collection('dishes').get();
      const list = document.getElementById('dishes-list');
      list.innerHTML = '';
      dishes.forEach(dish => {
        list.innerHTML += `<li>${dish.data().name} - ${dish.data().price} руб. (${dish.data().category})</li>`;
      });
    }

    async function loadCategories() {
      const categories = await db.collection('categories').get();
      const select = document.getElementById('dish-category');
      select.innerHTML = '';
      categories.forEach(cat => {
        select.innerHTML += `<option value="${cat.id}">${cat.data().name}</option>`;
      });
    }

    // Инвентаризация
    async function addIngredient() {
      const name = document.getElementById('ingredient-name').value;
      const quantity = parseInt(document.getElementById('ingredient-quantity').value);
      const price = parseInt(document.getElementById('ingredient-price').value);
      await db.collection('ingredients').add({ name, quantity, price });
      loadInventory();
    }

    async function loadInventory() {
      const ingredients = await db.collection('ingredients').get();
      const list = document.getElementById('inventory-list');
      list.innerHTML = '';
      ingredients.forEach(ing => {
        list.innerHTML += `<li>${ing.data().name} - ${ing.data().quantity} (Цена: ${ing.data().price} руб.)</li>`;
      });
    }

    // Заказ ингредиентов
    async function loadOrderIngredients() {
      const ingredients = await db.collection('ingredients').get();
      const list = document.getElementById('order-ingredients-list');
      list.innerHTML = '';
      ingredients.forEach(ing => {
        if (ing.data().quantity < 10) { // Пример порога для заказа
          list.innerHTML += `<li>${ing.data().name} - Нужно: ${10 - ing.data().quantity}</li>`;
        }
      });
    }

    async function placeIngredientOrder() {
      // Логика заказа ингредиентов
      alert('Заказ ингредиентов оформлен!');
    }

    // Отчетность
    async function loadPersonalReport() {
      const orders = await db.collection('orders').where('user', '==', auth.currentUser.uid).get();
      const list = document.getElementById('personal-report-list');
      list.innerHTML = '';
      orders.forEach(order => {
        list.innerHTML += `<li>Заказ: ${order.data().items.map(item => item.name).join(', ')}</li>`;
      });
    }

    async function generateGeneralReport() {
      const start = new Date(document.getElementById('report-start').value);
      const end = new Date(document.getElementById('report-end').value);
      const orders = await db.collection('orders').where('timestamp', '>=', start).where('timestamp', '<=', end).get();
      const list = document.getElementById('general-report-list');
      list.innerHTML = '';
      orders.forEach(order => {
        list.innerHTML += `<li>Заказ: ${order.data().items.map(item => item.name).join(', ')}</li>`;
      });
    }

    // Сотрудники
    async function addEmployee() {
      const name = document.getElementById('employee-name').value;
      const phone = document.getElementById('employee-phone').value;
      await db.collection('employees').add({ name, phone });
      loadEmployees();
    }

    async function loadEmployees() {
      const employees = await db.collection('employees').get();
      const list = document.getElementById('employees-list');
      list.innerHTML = '';
      employees.forEach(emp => {
        list.innerHTML += `<li>${emp.data().name} - ${emp.data().phone}</li>`;
      });
    }

    // Доставка
    async function loadDeliveryMenu() {
      const categories = await db.collection('categories').get();
      const dishes = await db.collection('dishes').get();
      const deliveryMenu = document.getElementById('delivery-menu');
      deliveryMenu.innerHTML = '';
      categories.forEach(cat => {
        const catDiv = document.createElement('div');
        catDiv.innerHTML = `<h2 class="text-xl">${cat.data().name}</h2>`;
        dishes.forEach(dish => {
          if (dish.data().category === cat.id) {
            catDiv.innerHTML += `
              <div class="border p-2">
                <p>${dish.data().name} - ${dish.data().price} руб.</p>
                <button onclick="addToDeliveryOrder('${dish.id}', '${dish.data().name}', ${dish.data().price})" class="bg-blue-600 text-white p-1 rounded">Добавить</button>
              </div>`;
          }
        });
        deliveryMenu.appendChild(catDiv);
      });
    }

    let deliveryOrderItems = [];
    function addToDeliveryOrder(dishId, name, price) {
      deliveryOrderItems.push({ dishId, name, price });
      renderDeliveryOrder();
    }

    function renderDeliveryOrder() {
      const orderList = document.getElementById('delivery-order-items');
      orderList.innerHTML = '';
      deliveryOrderItems.forEach(item => {
        orderList.innerHTML += `<li>${item.name} - ${item.price} руб.</li>`;
      });
    }

    async function placeDeliveryOrder() {
      const address = document.getElementById('delivery-address').value;
      const comment = document.getElementById('delivery-comment').value;
      await db.collection('delivery-orders').add({
        items: deliveryOrderItems,
        address,
        comment,
        user: auth.currentUser.uid,
        status: 'pending',
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      deliveryOrderItems = [];
      renderDeliveryOrder();
      alert('Заказ доставки оформлен!');
    }

    async function loadDeliveryOrders() {
      const orders = await db.collection('delivery-orders').get();
      const list = document.getElementById('delivery-orders-list');
      list.innerHTML = '';
      orders.forEach(order => {
        list.innerHTML += `
          <li>
            Заказ: ${order.data().items.map(item => item.name).join(', ')}<br>
            Адрес: ${order.data().address}<br>
            Статус: ${order.data().status}
            <button onclick="updateDeliveryStatus('${order.id}', 'confirmed')" class="bg-green-600 text-white p-1 rounded ml-2">Подтвердить</button>
            <button onclick="updateDeliveryStatus('${order.id}', 'cancelled')" class="bg-red-600 text-white p-1 rounded ml-2">Отменить</button>
          </li>`;
      });
    }

    async function updateDeliveryStatus(orderId, status) {
      await db.collection('delivery-orders').doc(orderId).update({ status });
      loadDeliveryOrders();
    }

    // Инициализация
    auth.onAuthStateChanged(user => {
      if (user) {
        showPage('menu');
        loadMenu();
        loadPromocodes();
        loadDishes();
        loadCategories();
        loadInventory();
        loadOrderIngredients();
        loadPersonalReport();
        loadEmployees();
        loadDeliveryMenu();
        loadDeliveryOrders();
      } else {
        showPage('login');
      }
    });
  </script>
</body>
</html>
